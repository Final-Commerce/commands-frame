# addCartDiscount

Adds a discount to the entire cart in the parent application. Cart discounts apply to the cart subtotal and affect all items in the cart.

## Parameters

### `AddCartDiscountParams`

```typescript
interface AddCartDiscountParams {
    amount: number;        // Required
    isPercent?: boolean;   // Optional, default: false
    label?: string;        // Optional, default: "Discount"
}
```

#### `amount` (required)

The discount amount. The interpretation depends on the `isPercent` flag:

- If `isPercent` is `false` (default): The amount is a fixed dollar value (e.g., `10` = $10.00 discount)
- If `isPercent` is `true`: The amount is a percentage value (e.g., `10` = 10% discount)

**Examples:**
- Fixed amount: `amount: 5.50` with `isPercent: false` → $5.50 discount
- Percentage: `amount: 15` with `isPercent: true` → 15% discount

#### `isPercent` (optional)

Whether the discount amount is a percentage or a fixed amount. Defaults to `false` (fixed amount).

- `true`: The `amount` is treated as a percentage (0-100)
- `false`: The `amount` is treated as a fixed dollar value (default)

#### `label` (optional)

A label for the discount that will be displayed in the cart and on receipts. Defaults to `"Discount"` if not provided.

**Examples:**
- "Holiday Sale"
- "Bulk Discount"
- "Loyalty Discount"
- "Promotion"

## Response

### `AddCartDiscountResponse`

```typescript
interface AddCartDiscountResponse {
    success: boolean;
    amount: number;
    isPercent: boolean;
    label: string;
    timestamp: string;
}
```

#### `success` (boolean)

Indicates whether the discount was successfully added to the cart.

#### `amount` (number)

The discount amount that was applied (echoed back from the request).

#### `isPercent` (boolean)

Whether the discount is a percentage or fixed amount (echoed back from the request).

#### `label` (string)

The discount label that was used (echoed back from the request).

#### `timestamp` (string)

ISO 8601 timestamp string (e.g., `"2024-01-01T00:00:00.000Z"`) indicating when the response was generated by the handler.

## Usage

```typescript
import { commands } from '@final-commerce/commands-frame';
```

## Usage Examples

### Fixed Amount Cart Discount

Add a fixed $10 discount to the entire cart:

```typescript
import { commands } from '@final-commerce/commands-frame';

const result = await commands.addCartDiscount({
    amount: 10,
    isPercent: false,
    label: 'Holiday Sale'
});

console.log(`Added $${result.amount} cart discount`);
```

### Percentage Cart Discount

Add a 15% discount to the entire cart:

```typescript
const result = await commands.addCartDiscount({
    amount: 15,
    isPercent: true,
    label: 'Bulk Discount'
});

console.log(`Added ${result.amount}% cart discount`);
```

### Discount with Custom Label

Add a discount with a descriptive label:

```typescript
const result = await commands.addCartDiscount({
    amount: 5.50,
    isPercent: false,
    label: 'Loyalty Customer Discount'
});
```

### Complete Workflow

Typical workflow: Add products to cart, then apply cart discount:

```typescript
// 1. Set product as active and add to cart
await commands.setProductActive({
    variantId: 'variant-id-123'
});

await commands.addProductToCart({
    quantity: 2
});

// 2. Add another product
await commands.setProductActive({
    variantId: 'variant-id-456'
});

await commands.addProductToCart({
    quantity: 1
});

// 3. Apply cart discount
await commands.addCartDiscount({
    amount: 10,
    isPercent: false,
    label: 'Promotion Discount'
});
```

### Error Handling

Handle validation errors:

```typescript
try {
    const result = await commands.addCartDiscount({
        amount: 10,
        isPercent: false
    });
} catch (error) {
    if (error.message === 'Discount amount is required') {
        console.error('Please provide a discount amount');
    } else if (error.message === 'Parameters are required for addCartDiscount') {
        console.error('Please provide parameters');
    } else {
        console.error('Failed to add cart discount:', error.message);
    }
}
```

## Behavior

When a cart discount is added:

1. The discount is validated (amount must be provided)
2. The discount is applied to the entire cart in the parent application
3. The discount type (percentage or fixed) is stored correctly
4. The discount label is stored for display purposes
5. The discount affects the cart's total calculation
6. Taxes are recalculated based on the discounted subtotal

## Discount Calculation

### Fixed Amount Discount

When `isPercent: false`:
- The discount amount is subtracted directly from the cart subtotal
- Example: Cart subtotal $100.00, discount $10.00 → Final subtotal $90.00

### Percentage Discount

When `isPercent: true`:
- The discount percentage is calculated from the cart subtotal
- Example: Cart subtotal $100.00, discount 10% → Discount amount $10.00, Final subtotal $90.00

## Cart Discount vs Product Discount

**Cart Discount:**
- Applies to the entire cart subtotal
- Affects all items in the cart
- Applied after all product-level discounts
- One cart discount can be active at a time

**Product Discount:**
- Applies to individual products
- Must be set on active product before adding to cart
- Each product can have its own discount
- Use `addProductDiscount` for product-level discounts

## Error Handling

The handler will throw errors in the following cases:

### Missing Parameters

```typescript
// Throws: "Parameters are required for addCartDiscount"
await commands.addCartDiscount();
```

### Missing Amount

```typescript
// Throws: "Discount amount is required"
await commands.addCartDiscount({
    isPercent: false
});
```

## Validation Rules

- `amount` must be provided and can be any number
- `isPercent` is optional and defaults to `false`
- `label` is optional and defaults to `"Discount"`
- For percentage discounts, the amount typically ranges from 0 to 100, but the handler doesn't enforce this limit
- Negative amounts are allowed (though not typically used)

## Notes

- Only one cart discount can be active at a time (adding a new discount replaces the previous one)
- The cart discount is applied to the cart subtotal (after product discounts)
- Taxes are recalculated when a cart discount is applied
- The discount affects the final cart total
- Cart discounts are displayed separately from product discounts in the cart summary
- The discount persists until:
  - A new cart discount is added (replaces the old one)
  - The cart discount is explicitly removed
  - The cart is cleared

