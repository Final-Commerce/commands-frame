# addCustomer

Adds a new customer to the local database in the parent application.

## Parameters

### `AddCustomerParams`

```typescript
interface AddCustomerParams {
    customer: Record<string, any>;
}
```

#### `customer` (required)

The customer object to create. The type is `Record<string, any>` to allow flexibility between different database implementations. Only `email` is required; all other fields are optional.

**Typical customer structure:**

**Required fields:**

- `email` (string): Customer email address. Must be unique and valid.

**Optional fields:**

- `firstName` (string): Customer's first name.
- `lastName` (string): Customer's last name.
- `phone` (string): Customer's phone number.
- `tags` (string[]): Array of tags to associate with the customer.
- `metadata` (Array<{ key: string; value: string }>): Custom metadata as key-value pairs.
- `notes` (Array<{ createdAt: Date | string; message: string }>): Array of notes associated with the customer.
- `billing` (object): Billing address information (see Address Structure below).
- `shipping` (object): Shipping address information (see Address Structure below).
- `totalSpent` (string): Total amount the customer has spent.
- `lastAction` (Date | string): Timestamp of the customer's last action.
- `outletId` (string): ID of the outlet associated with the customer.
- `externalId` (string): External system identifier.
- `fromOliver` (boolean): Indicates if the customer originated from Oliver system.

### Address Structure

Both `billing` and `shipping` typically follow this structure:

```typescript
// Reference structure
{
    firstName?: string;
    lastName?: string;
    company?: string;
    address1: string;        // Required
    address2?: string;
    city: string;            // Required
    state: string;           // Required
    country: string;         // Required
    postCode: string;        // Required
}
```

### Metadata Structure

```typescript
// Reference structure
{
    key: string;    // Required
    value: string;  // Required
}
```

### Notes Structure

```typescript
// Reference structure
{
    createdAt: Date | string;  // Required
    message: string;           // Required
}
```

## Response

### `AddCustomerResponse`

```typescript
interface AddCustomerResponse {
    success: boolean;
    customer: any;
    timestamp: string;
}
```

#### `success` (boolean)

Indicates whether the customer was successfully created.

#### `customer` (any)

The created customer object, including all fields from the request plus automatically generated fields. The structure depends on the database implementation:
- `id` or `_id`: ID field (structure depends on database - MongoDB uses `_id`, LokiJS/IndexedDB may use `id`)
- `createdAt`: Creation timestamp
- `updatedAt`: Last update timestamp
- `fromOliver`: Default value based on system configuration (if not provided)

The customer object is returned as `any` to allow flexibility between different database implementations.

#### `timestamp` (string)

ISO 8601 timestamp string (e.g., `"2024-01-01T00:00:00.000Z"`) indicating when the response was generated by the handler.

## Usage

```typescript
import { commands } from '@final-commerce/commands-frame';
```

## Usage Examples

### Minimal Customer Creation

Create a customer with only the required email:

```typescript
import { commands } from '@final-commerce/commands-frame';

const result = await commands.addCustomer({
    customer: {
        email: 'john.doe@example.com'
    }
});

console.log(result.customer);
```

### Customer with Basic Information

Create a customer with name and phone:

```typescript
const result = await commands.addCustomer({
    customer: {
        email: 'jane.smith@example.com',
        firstName: 'Jane',
        lastName: 'Smith',
        phone: '+1-555-123-4567'
    }
});
```

### Customer with Addresses

Create a customer with billing and shipping addresses:

```typescript
const result = await commands.addCustomer({
    customer: {
        email: 'customer@example.com',
        firstName: 'John',
        lastName: 'Doe',
        billing: {
            address1: '123 Main St',
            city: 'New York',
            state: 'NY',
            country: 'USA',
            postCode: '10001'
        },
        shipping: {
            address1: '456 Oak Ave',
            address2: 'Suite 100',
            city: 'Los Angeles',
            state: 'CA',
            country: 'USA',
            postCode: '90001'
        }
    }
});
```

### Customer with Metadata and Tags

Create a customer with custom metadata and tags:

```typescript
const result = await commands.addCustomer({
    customer: {
        email: 'vip@example.com',
        firstName: 'VIP',
        lastName: 'Customer',
        tags: ['vip', 'premium'],
        metadata: [
            { key: 'loyaltyLevel', value: 'gold' },
            { key: 'referralSource', value: 'website' }
        ]
    }
});
```

### Customer with Notes

Create a customer with initial notes:

```typescript
const result = await commands.addCustomer({
    customer: {
        email: 'noted@example.com',
        firstName: 'Noted',
        lastName: 'Customer',
        notes: [
            {
                createdAt: new Date().toISOString(),
                message: 'Initial customer registration'
            }
        ]
    }
});
```

### Complete Customer Example

Create a customer with all available fields:

```typescript
const result = await commands.addCustomer({
    customer: {
        email: 'complete@example.com',
        firstName: 'Complete',
        lastName: 'Customer',
        phone: '+1-555-999-8888',
        tags: ['new', 'verified'],
        metadata: [
            { key: 'source', value: 'mobile-app' }
        ],
        notes: [
            {
                createdAt: new Date().toISOString(),
                message: 'Customer signed up via mobile app'
            }
        ],
        billing: {
            firstName: 'Complete',
            lastName: 'Customer',
            address1: '789 Elm St',
            city: 'Chicago',
            state: 'IL',
            country: 'USA',
            postCode: '60601'
        },
        shipping: {
            firstName: 'Complete',
            lastName: 'Customer',
            address1: '789 Elm St',
            city: 'Chicago',
            state: 'IL',
            country: 'USA',
            postCode: '60601'
        },
        outletId: 'outlet-123',
        externalId: 'ext-customer-456',
        fromOliver: false
    }
});
```

## Error Handling

If the customer creation fails, the handler will throw an error:

```typescript
try {
    const result = await commands.addCustomer({
        customer: {
            email: 'invalid-email' // Missing required email format
        }
    });
} catch (error) {
    console.error('Failed to add customer:', error.message);
    // Error: customer data is required
}
```

Common error scenarios:

- Missing `customer` object: "customer data is required"
- Invalid email format: Validation error from the database
- Duplicate email: Database constraint violation

## Validation Rules

- `email` is required and must be a valid email format
- `billing.address1`, `billing.city`, `billing.state`, `billing.country`, and `billing.postCode` are required if `billing` is provided
- `shipping.address1`, `shipping.city`, `shipping.state`, `shipping.country`, and `shipping.postCode` are required if `shipping` is provided
- `metadata` items must have both `key` and `value` as strings
- `notes` items must have both `createdAt` and `message` fields

## Real Data Examples

### Example Response

```json
{
  "success": true,
  "customer": {
    "firstName": "John",
    "lastName": "Doe",
    "email": "newcustomer.test@example.com",
    "phone": "1234567890",
    "_id": "6931e04f53d9113bd5231dfd",
    "createdAt": "2025-12-04T19:26:07.316Z",
    "updatedAt": "2025-12-04T19:26:07.316Z"
  },
  "timestamp": "2025-12-04T19:26:07.316Z"
}
```

### Example Request

```json
{
  "customer": {
    "firstName": "John",
    "lastName": "Doe",
    "email": "newcustomer.test@example.com",
    "phone": "1234567890"
  }
}
```

## Notes

- The customer is created in the local IndexedDB database (LokiJS)
- Generated fields (ID field, `createdAt`, `updatedAt`) are automatically added
- The ID field structure depends on the database implementation (may be `id`, `_id`, or other formats)
- The `fromOliver` field defaults based on the system configuration
- Customer data is synchronized with the central MongoDB database via station-sync

