# addProductDiscount

Adds a discount to the currently active product in the parent application. The product must be set as active first using `setProductActive`.

## Parameters

### `AddProductDiscountParams`

```typescript
interface AddProductDiscountParams {
    amount: number;        // Required
    isPercent?: boolean;   // Optional, default: false
    label?: string;        // Optional, default: "Discount"
}
```

#### `amount` (required)

The discount amount. The interpretation depends on the `isPercent` flag:

- If `isPercent` is `false` (default): The amount is a fixed dollar value (e.g., `10` = $10.00 discount)
- If `isPercent` is `true`: The amount is a percentage value (e.g., `10` = 10% discount)

**Examples:**
- Fixed amount: `amount: 5.50` with `isPercent: false` → $5.50 discount
- Percentage: `amount: 15` with `isPercent: true` → 15% discount

#### `isPercent` (optional)

Whether the discount amount is a percentage or a fixed amount. Defaults to `false` (fixed amount).

- `true`: The `amount` is treated as a percentage (0-100)
- `false`: The `amount` is treated as a fixed dollar value (default)

#### `label` (optional)

A label for the discount that will be displayed in the cart and on receipts. Defaults to `"Discount"` if not provided.

**Examples:**
- "Employee Discount"
- "Loyalty Discount"
- "Special Promotion"
- "Holiday Sale"

## Response

### `AddProductDiscountResponse`

```typescript
interface AddProductDiscountResponse {
    success: boolean;
    amount: number;
    isPercent: boolean;
    label: string;
    timestamp: string;
}
```

#### `success` (boolean)

Indicates whether the discount was successfully added to the active product.

#### `amount` (number)

The discount amount that was applied (echoed back from the request).

#### `isPercent` (boolean)

Whether the discount is a percentage or fixed amount (echoed back from the request).

#### `label` (string)

The discount label that was used (echoed back from the request).

#### `timestamp` (string)

ISO 8601 timestamp string (e.g., `"2024-01-01T00:00:00.000Z"`) indicating when the response was generated by the handler.

## Usage

```typescript
import { commands } from '@final-commerce/commands-frame';
```

## Usage Examples

### Fixed Amount Discount

Add a fixed $10 discount to the active product:

```typescript
import { commands } from '@final-commerce/commands-frame';

// First, set a product as active
await commands.setProductActive({
    variantId: 'variant-id-123'
});

// Then add a fixed discount
const result = await commands.addProductDiscount({
    amount: 10,
    isPercent: false,
    label: 'Special Discount'
});

console.log(`Added $${result.amount} discount`);
```

### Percentage Discount

Add a 15% discount to the active product:

```typescript
const result = await commands.addProductDiscount({
    amount: 15,
    isPercent: true,
    label: 'Holiday Sale'
});

console.log(`Added ${result.amount}% discount`);
```

### Discount with Custom Label

Add a discount with a descriptive label:

```typescript
const result = await commands.addProductDiscount({
    amount: 5.50,
    isPercent: false,
    label: 'Employee Discount'
});
```

### Complete Workflow

Typical workflow: Set product active, add discount, then add to cart:

```typescript
// 1. Set product as active
await commands.setProductActive({
    variantId: 'variant-id-123'
});

// 2. Add discount
await commands.addProductDiscount({
    amount: 10,
    isPercent: false,
    label: 'Promotion Discount'
});

// 3. Add to cart
await commands.addProductToCart({ quantity: 1 });
```

### Error Handling

Handle errors when no product is active:

```typescript
try {
    const result = await commands.addProductDiscount({
        amount: 10,
        isPercent: false
    });
} catch (error) {
    if (error.message.includes('No active product')) {
        console.error('Please set a product as active first');
        // Set a product as active
        await commands.setProductActive({
            variantId: 'variant-id-123'
        });
        // Retry adding discount
        await commands.addProductDiscount({
            amount: 10,
            isPercent: false
        });
    } else if (error.message === 'Discount amount is required') {
        console.error('Please provide a discount amount');
    } else {
        console.error('Failed to add discount:', error.message);
    }
}
```

## Behavior

When a discount is added to the active product:

1. The discount is validated (amount must be provided)
2. The discount is applied to the active product in the parent application
3. The discount type (percentage or fixed) is stored correctly
4. The discount label is stored for display purposes
5. The discount affects the product's price calculation when added to cart

## Discount Calculation

### Fixed Amount Discount

When `isPercent: false`:
- The discount amount is subtracted directly from the product price
- Example: Product price $50.00, discount $10.00 → Final price $40.00

### Percentage Discount

When `isPercent: true`:
- The discount percentage is calculated from the product price
- Example: Product price $50.00, discount 10% → Discount amount $5.00, Final price $45.00

## Prerequisites

- A product must be set as active using `setProductActive` before adding a discount
- The active product must exist and be valid

## Error Handling

The handler will throw errors in the following cases:

### Missing Parameters

```typescript
// Throws: "Parameters are required for addProductDiscount"
await commands.addProductDiscount();
```

### Missing Amount

```typescript
// Throws: "Discount amount is required"
await commands.addProductDiscount({
    isPercent: false
});
```

### No Active Product

```typescript
// Throws: "No active product. Please set a product as active first."
await commands.addProductDiscount({
    amount: 10,
    isPercent: false
});
```

## Validation Rules

- `amount` must be provided and can be any number
- `isPercent` is optional and defaults to `false`
- `label` is optional and defaults to `"Discount"`
- For percentage discounts, the amount typically ranges from 0 to 100, but the handler doesn't enforce this limit
- Negative amounts are allowed (though not typically used)

## Notes

- The discount is applied to the active product, not to products already in the cart
- Only one discount can be active per product at a time (adding a new discount replaces the previous one)
- The discount persists on the active product until:
  - A new discount is added (replaces the old one)
  - The product is removed from active state
  - The discount is explicitly removed
- When the product is added to cart, the discount is included in the cart item
- The discount affects the line total calculation for the product

