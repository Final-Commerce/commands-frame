# addProductToCart

Adds the currently active product to the cart in the parent application. The product must be set as active first using `setProductActive`.

## Parameters

### `AddProductToCartParams`

```typescript
interface AddProductToCartParams {
    quantity?: number;  // Optional, default: active product's quantity or 1
}
```

#### `quantity` (optional)

The quantity of the product to add to the cart. If not provided:
1. Uses the active product's current quantity
2. If the active product has no quantity, defaults to 1

**Note:** If the product is already in the cart, the quantity will be added to the existing quantity (not replaced).

## Response

### `AddProductToCartResponse`

```typescript
interface AddProductToCartResponse {
    success: boolean;
    productId: string;
    variantId: string;
    name: string;
    quantity: number;
    timestamp: string;
}
```

#### `success` (boolean)

Indicates whether the product was successfully added to the cart.

#### `productId` (string)

The ID of the product that was added to the cart.

#### `variantId` (string)

The ID of the variant that was added to the cart.

#### `name` (string)

The name of the product that was added to the cart.

#### `quantity` (number)

The quantity that was added to the cart (may be different from requested if product was already in cart).

#### `timestamp` (string)

ISO 8601 timestamp string (e.g., `"2024-01-01T00:00:00.000Z"`) indicating when the response was generated by the handler.

## Usage

```typescript
import { commands } from '@final-commerce/commands-frame';
```

## Usage Examples

### Add Active Product to Cart (Default Quantity)

Add the active product to cart using its current quantity:

```typescript
import { commands } from '@final-commerce/commands-frame';

// First, set a product as active
await commands.setProductActive({
    variantId: 'variant-id-123'
});

// Then add to cart with default quantity
const result = await commands.addProductToCart();

console.log(`Added ${result.name} (quantity: ${result.quantity}) to cart`);
```

### Add with Specific Quantity

Add the active product to cart with a specific quantity:

```typescript
const result = await commands.addProductToCart({
    quantity: 3
});

console.log(`Added ${result.quantity} items to cart`);
```

### Complete Workflow

Typical workflow: Set product active, add discount, then add to cart:

```typescript
// 1. Set product as active
await commands.setProductActive({
    variantId: 'variant-id-123'
});

// 2. Optionally add discount
await commands.addProductDiscount({
    amount: 10,
    isPercent: false,
    label: 'Promotion Discount'
});

// 3. Add to cart with quantity
await commands.addProductToCart({
    quantity: 2
});
```

### Error Handling

Handle errors when no product is active:

```typescript
try {
    const result = await commands.addProductToCart({
        quantity: 1
    });
} catch (error) {
    if (error.message.includes('No active product')) {
        console.error('Please set a product as active first');
        // Set a product as active
        await commands.setProductActive({
            variantId: 'variant-id-123'
        });
        // Retry adding to cart
        await commands.addProductToCart({
            quantity: 1
        });
    } else {
        console.error('Failed to add product to cart:', error.message);
    }
}
```

## Behavior

When a product is added to the cart:

1. The active product is validated (must exist)
2. The quantity is determined (from parameter, active product, or default to 1)
3. If a different quantity is specified, the active product's quantity is updated first
4. The product is added to the cart with all its properties:
   - Product ID and variant ID
   - Name, price, and images
   - Tax table information
   - Stock information
   - Any discounts that were applied
   - Quantity
5. If the same variant is already in the cart, the quantities are combined

## Quantity Handling

### New Product in Cart

If the variant is not already in the cart:
- The product is added with the specified quantity

### Existing Product in Cart

If the variant is already in the cart:
- The new quantity is added to the existing quantity
- Example: Cart has 2 items, adding 3 more â†’ Cart now has 5 items

### Stock Limitations

- If stock management is enabled and stock is limited, the quantity may be adjusted based on available stock
- If stock is 0 and not unlimited, the product may not be added or quantity may be set to 0

## Prerequisites

- A product must be set as active using `setProductActive` before adding to cart
- The active product must exist and be valid

## Error Handling

The handler will throw errors in the following cases:

### No Active Product

```typescript
// Throws: "No active product. Please set a product as active first."
await commands.addProductToCart();
```

## Validation Rules

- `quantity` is optional and defaults to the active product's quantity or 1
- `quantity` should be a positive number (typically 1 or greater)
- The handler will use the active product's quantity if no quantity is provided

## Notes

- The product must be set as active before adding to cart
- Any discounts applied to the active product will be included when adding to cart
- The product's current price (including any discounts) is used when adding to cart
- Stock availability is considered when determining the quantity
- If the product is already in the cart, quantities are combined (not replaced)
- The active product state remains after adding to cart (you can add more or modify discounts)

